# Enhanced Projector Control Application - Release Workflow
# Triggered on version tags (v*)
# Builds and publishes releases with all distribution formats

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 2.0.1)'
        required: true
        type: string

env:
  PYTHON_VERSION: "3.12"

jobs:
  # ===========================================================================
  # Pre-Release Checks
  # ===========================================================================
  pre-release-checks:
    name: Pre-Release Validation
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Verify version consistency
        run: |
          python scripts/verify_version.py
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Version inconsistencies detected"
            exit 1
          }
        shell: pwsh

      - name: Run full test suite
        run: |
          pytest tests/ --cov=src --cov-fail-under=85
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Tests failed - cannot proceed with release"
            exit 1
          }
        shell: pwsh

      - name: Security scan
        run: |
          pip install bandit
          bandit -r src/ -ll -f json -o bandit-release.json
        continue-on-error: true

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: release-security-report
          path: bandit-release.json

  # ===========================================================================
  # Build All Distribution Formats
  # ===========================================================================
  build-distributions:
    name: Build Distribution Packages
    runs-on: windows-latest
    needs: pre-release-checks
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Get version
        id: get-version
        run: |
          $version = python -c "from src.__version__ import __version__; print(__version__)"
          echo "version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Building version: $version"
        shell: pwsh

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Generate version info
        run: |
          python scripts/generate_version_info.py

      - name: Build executable with PyInstaller
        run: |
          pyinstaller projector_control.spec --noconfirm --clean

      - name: Run smoke test
        run: |
          python scripts/smoke_test.py dist/ProjectorControl.exe
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Smoke test failed"
            exit 1
          }
        shell: pwsh

      - name: Generate build manifest
        run: |
          python scripts/build_manifest.py dist/ProjectorControl.exe

      - name: Create ZIP distribution
        run: |
          python scripts/create_zip_distribution.py ${{ steps.get-version.outputs.version }}

      - name: Download Inno Setup
        run: |
          $innoUrl = "https://jrsoftware.org/download.php/is.exe"
          Invoke-WebRequest -Uri $innoUrl -OutFile "innosetup.exe"
          Start-Process -FilePath "innosetup.exe" -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/SP-" -Wait
        shell: pwsh

      - name: Build Inno Setup installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer\projector_control.iss
        shell: pwsh

      - name: Generate release notes
        run: |
          python scripts/generate_release_notes.py ${{ steps.get-version.outputs.version }}
        continue-on-error: true

      - name: Generate checksums
        run: |
          $files = @(
            "dist\ProjectorControl.exe",
            "dist\ProjectorControl-v${{ steps.get-version.outputs.version }}.zip",
            "dist\ProjectorControl-v${{ steps.get-version.outputs.version }}-Setup.exe"
          )

          $checksums = ""
          foreach ($file in $files) {
            if (Test-Path $file) {
              $hash = (Get-FileHash -Path $file -Algorithm SHA256).Hash
              $filename = Split-Path -Leaf $file
              $checksums += "$hash  $filename`n"
              Write-Host "$filename`: $hash"
            }
          }

          $checksums | Out-File -FilePath "dist\checksums.txt" -Encoding UTF8
        shell: pwsh

      - name: Upload standalone executable
        uses: actions/upload-artifact@v4
        with:
          name: ProjectorControl-exe
          path: dist/ProjectorControl.exe

      - name: Upload ZIP distribution
        uses: actions/upload-artifact@v4
        with:
          name: ProjectorControl-zip
          path: dist/ProjectorControl-v${{ steps.get-version.outputs.version }}.zip

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: ProjectorControl-installer
          path: dist/ProjectorControl-v${{ steps.get-version.outputs.version }}-Setup.exe

      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: dist/checksums.txt

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: release-notes
          path: RELEASE_NOTES.md

  # ===========================================================================
  # Create GitHub Release
  # ===========================================================================
  create-release:
    name: Create GitHub Release
    runs-on: windows-latest
    needs: build-distributions
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts/

      - name: Prepare release assets
        run: |
          New-Item -ItemType Directory -Force -Path release-files
          Copy-Item -Path "release-artifacts\ProjectorControl-exe\*" -Destination "release-files\" -Force
          Copy-Item -Path "release-artifacts\ProjectorControl-zip\*" -Destination "release-files\" -Force
          Copy-Item -Path "release-artifacts\ProjectorControl-installer\*" -Destination "release-files\" -Force
          Copy-Item -Path "release-artifacts\checksums\*" -Destination "release-files\" -Force
          Get-ChildItem -Path "release-files\"
        shell: pwsh

      - name: Read release notes
        id: read-notes
        run: |
          if (Test-Path "release-artifacts\release-notes\RELEASE_NOTES.md") {
            $notes = Get-Content "release-artifacts\release-notes\RELEASE_NOTES.md" -Raw
            # Escape special characters for GitHub Actions
            $notes = $notes -replace '%', '%25'
            $notes = $notes -replace '\r', '%0D'
            $notes = $notes -replace '\n', '%0A'
            echo "notes=$notes" >> $env:GITHUB_OUTPUT
          } else {
            echo "notes=Release v${{ needs.build-distributions.outputs.version }}" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ needs.build-distributions.outputs.version }}
          body: ${{ steps.read-notes.outputs.notes }}
          files: |
            release-files/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Post-Release
  # ===========================================================================
  post-release:
    name: Post-Release Tasks
    runs-on: windows-latest
    needs: [build-distributions, create-release]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Record metrics
        run: |
          python scripts/collect_metrics.py --release
        continue-on-error: true

      - name: Post release summary
        run: |
          echo "## Release Summary" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.build-distributions.outputs.version }}" >> $env:GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ github.ref_name }}" >> $env:GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "### Distribution Formats Created:" >> $env:GITHUB_STEP_SUMMARY
          echo "- Standalone Executable (ProjectorControl.exe)" >> $env:GITHUB_STEP_SUMMARY
          echo "- ZIP Distribution (with documentation)" >> $env:GITHUB_STEP_SUMMARY
          echo "- Windows Installer (Inno Setup)" >> $env:GITHUB_STEP_SUMMARY
          echo "- SHA256 Checksums" >> $env:GITHUB_STEP_SUMMARY
        shell: pwsh
