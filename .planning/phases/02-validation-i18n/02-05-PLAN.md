---
phase: 02-validation-i18n
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/compatibility/__init__.py
  - tests/compatibility/test_windows_matrix.py
  - tests/compatibility/test_dpi_matrix.py
  - tests/compatibility/test_projector_matrix.py
  - tests/compatibility/conftest.py
  - docs/compatibility/COMPATIBILITY_MATRIX.md
autonomous: false
user_setup: []

must_haves:
  truths:
    - "Windows 10 and 11 compatibility documented"
    - "DPI scaling 100%-200% tested"
    - "EPSON and Hitachi projector protocols verified"
    - "Compatibility matrix documentation complete"
  artifacts:
    - path: "tests/compatibility/test_windows_matrix.py"
      provides: "Windows version compatibility tests"
      min_lines: 60
    - path: "tests/compatibility/test_dpi_matrix.py"
      provides: "DPI scaling tests"
      min_lines: 60
    - path: "tests/compatibility/test_projector_matrix.py"
      provides: "Projector protocol tests"
      min_lines: 80
    - path: "docs/compatibility/COMPATIBILITY_MATRIX.md"
      provides: "Complete compatibility documentation"
      min_lines: 100
  key_links:
    - from: "tests/compatibility/test_dpi_matrix.py"
      to: "PyQt6.QtWidgets.QApplication"
      via: "devicePixelRatio()"
      pattern: "devicePixelRatio"
    - from: "tests/compatibility/test_projector_matrix.py"
      to: "tests/mocks/pjlink_server.py"
      via: "mock server for protocol testing"
      pattern: "MockPJLinkServer|mock_pjlink"
---

<objective>
Create and execute compatibility test matrix for Windows, DPI scaling, and projector protocols.

Purpose: Verify the application works correctly across supported Windows versions, display configurations, and projector brands. Fulfills requirements QA-04 (Windows matrix), QA-05 (DPI matrix), QA-06 (projector matrix).

Output: Compatibility test suite and comprehensive documentation of tested configurations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/GSD_ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-validation-i18n/02-RESEARCH.md
@tests/mocks/pjlink_server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Windows and DPI compatibility tests</name>
  <files>
    - tests/compatibility/__init__.py
    - tests/compatibility/conftest.py
    - tests/compatibility/test_windows_matrix.py
    - tests/compatibility/test_dpi_matrix.py
  </files>
  <action>
    1. Create tests/compatibility/__init__.py:
       - Module docstring explaining compatibility testing
       - Version constants for supported Windows builds

    2. Create tests/compatibility/conftest.py:
       - Import pytest, sys, platform
       - @pytest.fixture for windows_info() - returns (version, build)
       - @pytest.fixture for display_info() - returns (dpi, scaling, resolution)
       - Add pytest_configure hook to register markers: 'windows', 'dpi', 'projector'
       - Helper function get_windows_build() using platform.win32_ver()

    3. Create tests/compatibility/test_windows_matrix.py:
       - @pytest.mark.windows
       - class TestWindowsCompatibility:
         - test_windows_version_supported():
           - Get Windows version via platform.win32_ver()
           - Assert version is Windows 10 (10.0) or Windows 11
           - Log exact build number for documentation
         - test_windows_required_features():
           - Check DPAPI available (try import win32crypt)
           - Check ODBC available (try import pyodbc)
           - Check Windows Credential Manager accessible
         - test_windows_path_handling():
           - Create temp file with Windows path
           - Verify pathlib handles correctly
           - Test with spaces in path, unicode characters
         - test_windows_registry_access():
           - Verify can read from HKEY_CURRENT_USER
           - No write tests (read-only is sufficient)

    4. Create tests/compatibility/test_dpi_matrix.py:
       - @pytest.mark.dpi
       - class TestDPICompatibility:
         - test_detect_current_dpi(qtbot):
           - Create QApplication, get devicePixelRatio()
           - Log actual DPI and scaling factor
         - test_ui_elements_scale_correctly(qtbot):
           - Create MainWindow
           - Get actual sizes of key elements
           - Verify proportions maintained (width/height ratios)
         - test_icons_not_blurry(qtbot):
           - Load SVG icons at current DPI
           - Verify icon size matches requested size * dpi_ratio
         - test_font_readability(qtbot):
           - Create labels with standard font
           - Verify font size >= 10 * dpi_ratio
         - test_minimum_window_size_respects_dpi(qtbot):
           - Get minimum window size
           - Verify >= 520 * dpi_ratio width

    5. Add DPI simulation helper (if possible):
       - Note: Actual DPI changes require system settings
       - Tests primarily document current configuration
       - Add TODO for manual testing checklist
  </action>
  <verify>
    - Run: pytest tests/compatibility/test_windows_matrix.py tests/compatibility/test_dpi_matrix.py -v
    - Tests pass on current Windows configuration
  </verify>
  <done>
    - Windows compatibility tests verify supported features
    - DPI tests document current scaling behavior
    - Tests log configuration for matrix documentation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create projector protocol compatibility tests</name>
  <files>
    - tests/compatibility/test_projector_matrix.py
  </files>
  <action>
    1. Create tests/compatibility/test_projector_matrix.py:
       - @pytest.mark.projector
       - Import MockPJLinkServer from tests/mocks/
       - Import PJLinkCommands, PJLinkResponse from src/network/

       class TestPJLinkProtocolClass1:
           """PJLink Class 1 commands (mandatory for all projectors)."""

           - test_power_on_command_encoding():
             - Verify POWR 1 command format
           - test_power_off_command_encoding():
             - Verify POWR 0 command format
           - test_power_status_query():
             - Verify POWR ? query and response parsing
           - test_input_switch_command():
             - Verify INPT command format for various inputs
           - test_error_response_parsing():
             - Verify ERR1, ERR2, ERR3, ERR4 handling

       class TestPJLinkProtocolClass2:
           """PJLink Class 2 commands (extended functionality)."""

           - test_freeze_command():
             - Verify FREZ command if supported
           - test_serial_number_query():
             - Verify SNUM query
           - test_lamp_hours_query():
             - Verify LAMP query and response parsing

       class TestEPSONQuirks:
           """EPSON-specific protocol quirks."""

           - test_epson_extended_status():
             - Document any EPSON-specific responses
           - test_epson_input_naming():
             - HDMI1, HDMI2, VGA, etc.

       class TestHitachiQuirks:
           """Hitachi-specific protocol quirks."""

           - test_hitachi_authentication():
             - Document authentication behavior
           - test_hitachi_input_naming():
             - Input source names

       class TestMockServerValidation:
           """Validate mock server behaves like real projector."""

           - test_mock_server_power_cycle(mock_pjlink_server):
             - Start mock, send power on, verify state change
           - test_mock_server_authentication(mock_pjlink_server):
             - Test with/without password
           - test_mock_server_error_simulation(mock_pjlink_server):
             - Simulate various error conditions

    2. Use mock server for all automated tests
    3. Add manual test checklist for real hardware
  </action>
  <verify>
    - Run: pytest tests/compatibility/test_projector_matrix.py -v
    - All protocol tests pass with mock server
  </verify>
  <done>
    - PJLink Class 1 and 2 commands tested
    - Brand-specific quirks documented
    - Mock server validates protocol compliance
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Compatibility test suite for Windows, DPI, and projector protocols.
    Automated tests verify protocol compliance and log configuration data.
  </what-built>
  <how-to-verify>
    1. Run compatibility tests:
       ```bash
       pytest tests/compatibility/ -v -s
       ```

    2. Review test output for configuration data:
       - Windows version and build
       - Current DPI scaling
       - Protocol test results

    3. If available, test on different configurations:
       - Different Windows 10/11 versions (VM or physical)
       - Different DPI settings (100%, 125%, 150%)
       - Real projector hardware (EPSON, Hitachi)

    4. Record results for COMPATIBILITY_MATRIX.md
  </how-to-verify>
  <resume-signal>Type "approved" with any additional compatibility notes, or describe issues found</resume-signal>
</task>

<task type="auto">
  <name>Task 4: Create compatibility matrix documentation</name>
  <files>
    - docs/compatibility/COMPATIBILITY_MATRIX.md
  </files>
  <action>
    Create docs/compatibility/COMPATIBILITY_MATRIX.md with:

    # Compatibility Matrix

    ## Overview
    - Testing date: [current date]
    - Application version: 1.0.0
    - Test methodology: Automated + Manual

    ## Windows Compatibility

    | Windows Version | Build | Status | Notes |
    |-----------------|-------|--------|-------|
    | Windows 10 21H2 | 19044 | Verified | Primary test platform |
    | Windows 10 22H2 | 19045 | Verified | [notes] |
    | Windows 11 21H2 | 22000 | Verified | [notes] |
    | Windows 11 22H2 | 22621 | Verified | [notes] |
    | Windows 11 23H2 | 22631 | Untested | Expected compatible |

    ### Windows Feature Requirements
    - DPAPI: Required for credential encryption
    - ODBC: Required for SQL Server mode
    - .NET Framework: Not required

    ## Display/DPI Compatibility

    | Scaling | DPI | Resolution | Status | Notes |
    |---------|-----|------------|--------|-------|
    | 100% | 96 | 1920x1080 | Verified | Baseline |
    | 125% | 120 | 1920x1080 | Verified | [notes] |
    | 150% | 144 | 2560x1440 | Verified | [notes] |
    | 175% | 168 | 3840x2160 | Untested | Expected compatible |
    | 200% | 192 | 3840x2160 | Untested | Expected compatible |

    ### DPI Notes
    - PyQt6 handles high DPI automatically via Qt6
    - SVG icons scale without blur
    - Minimum window size: 520x380 at 100%

    ## Projector Compatibility

    | Brand | Model | Protocol | Status | Notes |
    |-------|-------|----------|--------|-------|
    | EPSON | [models] | PJLink Class 2 | Mock verified | [notes] |
    | Hitachi | [models] | PJLink Class 1 | Mock verified | [notes] |
    | Panasonic | [models] | PJLink Class 2 | Untested | Expected compatible |
    | Sony | [models] | PJLink Class 2 | Untested | Expected compatible |

    ### PJLink Protocol Support
    - Class 1: Power, Input, Status queries (all projectors)
    - Class 2: Freeze, Serial, extended queries (some projectors)

    ### Known Projector Quirks
    - EPSON: [any quirks found]
    - Hitachi: [any quirks found]

    ## Test Evidence
    - Automated tests: tests/compatibility/
    - Test run date: [date]
    - Test environment: [description]

    ## Manual Testing Checklist
    For configurations not automated:
    - [ ] Windows 10 on VM
    - [ ] Windows 11 on VM
    - [ ] 125% DPI setting
    - [ ] 150% DPI setting
    - [ ] Real EPSON projector
    - [ ] Real Hitachi projector
  </action>
  <verify>
    - File exists: docs/compatibility/COMPATIBILITY_MATRIX.md
    - Contains Windows, DPI, and Projector sections
    - Status column populated from test results
  </verify>
  <done>
    - Comprehensive compatibility matrix documented
    - Test evidence linked
    - Manual testing checklist provided
  </done>
</task>

</tasks>

<verification>
Run all compatibility tests:
```bash
pytest tests/compatibility/ -v -s
```

Check documentation:
```bash
cat docs/compatibility/COMPATIBILITY_MATRIX.md
```

Manual verification points:
- Windows version displayed correctly
- DPI scaling logged
- Projector protocol tests pass
</verification>

<success_criteria>
- QA-04: Windows compatibility matrix tested
  - Windows 10 21H2, 22H2 verified
  - Windows 11 21H2, 22H2 verified
  - Required features (DPAPI, ODBC) confirmed
- QA-05: Display/DPI matrix tested
  - 100%, 125%, 150% scaling documented
  - UI elements scale correctly
  - Icons not blurry
- QA-06: Projector compatibility matrix tested
  - EPSON PJLink protocol verified (mock)
  - Hitachi PJLink protocol verified (mock)
  - Known quirks documented
- COMPATIBILITY_MATRIX.md complete and accurate
</success_criteria>

<output>
After completion, create `.planning/phases/02-validation-i18n/02-05-SUMMARY.md`
</output>
