---
phase: 02-validation-i18n
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main.py
  - src/ui/main_window.py
  - src/ui/widgets/status_panel.py
  - src/ui/widgets/controls_panel.py
  - src/ui/widgets/history_panel.py
  - src/ui/dialogs/first_run_wizard.py
  - src/resources/qss/light.qss
  - tests/unit/test_rtl_layout.py
  - tests/integration/test_hebrew_ui.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can switch language to Hebrew via settings"
    - "Hebrew mode displays all UI text in Hebrew"
    - "Hebrew mode uses RTL layout direction"
    - "Directional icons (arrows, chevrons) mirror in RTL"
    - "QHBoxLayout child widgets reverse order in RTL"
  artifacts:
    - path: "src/main.py"
      provides: "Application-level RTL layout direction setting"
      contains: "setLayoutDirection"
    - path: "src/ui/main_window.py"
      provides: "MainWindow RTL propagation"
      contains: "Qt.LayoutDirection.RightToLeft"
    - path: "tests/unit/test_rtl_layout.py"
      provides: "RTL layout unit tests"
      min_lines: 50
    - path: "tests/integration/test_hebrew_ui.py"
      provides: "Hebrew UI integration tests"
      min_lines: 80
  key_links:
    - from: "src/main.py"
      to: "TranslationManager.is_rtl()"
      via: "QApplication.setLayoutDirection"
      pattern: "is_rtl.*setLayoutDirection"
    - from: "src/ui/main_window.py"
      to: "src/resources/translations/__init__.py"
      via: "get_translation_manager"
      pattern: "get_translation_manager"
---

<objective>
Implement full Hebrew/RTL support across all UI components.

Purpose: Enable Hebrew-speaking users to use the application with proper RTL layout and translated text. This fulfills requirements I18N-03, I18N-04, and I18N-05.

Output: All UI components display correctly in RTL mode with Hebrew text, directional icons mirrored, and layout reversed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/GSD_ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-validation-i18n/02-RESEARCH.md
@src/resources/translations/__init__.py
@src/ui/main_window.py
@src/ui/widgets/status_panel.py
@src/ui/widgets/controls_panel.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply RTL layout at application level and propagate to all widgets</name>
  <files>
    - src/main.py
    - src/ui/main_window.py
    - src/ui/widgets/status_panel.py
    - src/ui/widgets/controls_panel.py
    - src/ui/widgets/history_panel.py
    - src/ui/dialogs/first_run_wizard.py
  </files>
  <action>
    1. In src/main.py, after QApplication creation and before main window:
       - Get TranslationManager instance
       - If is_rtl(), call app.setLayoutDirection(Qt.LayoutDirection.RightToLeft)
       - This applies RTL globally to ALL widgets

    2. In src/ui/main_window.py:
       - Remove the existing RTL check at line 146-147 (now handled at app level)
       - Add language_changed signal
       - Add set_language(lang: str) method that:
         - Updates TranslationManager
         - Refreshes all translated text via _retranslate_ui()
         - Emits language_changed signal
       - Implement _retranslate_ui() to update all t() calls

    3. In each widget (status_panel.py, controls_panel.py, history_panel.py):
       - Add retranslate() method to update all translated strings
       - Ensure all user-visible strings use t() function

    4. In first_run_wizard.py:
       - Add language selection page (first page)
       - Apply RTL immediately when Hebrew selected
       - Store language preference in settings

    Note: PyQt6 QHBoxLayout automatically reverses child widget order when RTL is set at application level. No manual reversal needed.
  </action>
  <verify>
    - Run: python -c "from src.main import main; from PyQt6.QtWidgets import QApplication; app = QApplication([]); from src.resources.translations import get_translation_manager; tm = get_translation_manager('he'); print('RTL:', tm.is_rtl())"
    - Verify output shows RTL: True
  </verify>
  <done>
    - Setting language to Hebrew at app level applies RTL to all widgets
    - All panels have retranslate() methods
    - First-run wizard includes language selection
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement directional icon mirroring for RTL mode</name>
  <files>
    - src/resources/icons/__init__.py
    - src/resources/qss/light.qss
  </files>
  <action>
    1. In src/resources/icons/__init__.py (IconLibrary class):
       - Add DIRECTIONAL_ICONS list = ['arrow_left', 'arrow_right', 'chevron_left', 'chevron_right', 'back', 'forward', 'next', 'previous']
       - Add is_rtl parameter to get_icon() and get_pixmap() methods
       - For directional icons when is_rtl=True:
         - Use QPixmap.transformed() with QTransform().scale(-1, 1) to flip horizontally
       - Add get_icon_rtl_aware() convenience method that auto-detects RTL from TranslationManager

    2. In src/resources/qss/light.qss:
       - Add RTL-specific margins using :right-to-left pseudo-class
       - Example: QWidget:right-to-left { margin-right: 8px; margin-left: 0px; }
       - Adjust any hardcoded left/right margins to be symmetric or RTL-aware

    3. Update icon usages in UI files to use get_icon_rtl_aware() for directional icons
  </action>
  <verify>
    - Run: python -c "from src.resources.icons import IconLibrary; from PyQt6.QtCore import QSize; from PyQt6.QtWidgets import QApplication; app = QApplication([]); p1 = IconLibrary.get_pixmap('arrow_right', QSize(24,24)); p2 = IconLibrary.get_pixmap('arrow_right', QSize(24,24), is_rtl=True); print('Different:', p1.toImage() != p2.toImage())"
    - Verify output shows Different: True (icons are flipped)
  </verify>
  <done>
    - Directional icons flip horizontally in RTL mode
    - QSS styles include RTL-specific rules
    - get_icon_rtl_aware() method available for convenience
  </done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive RTL and Hebrew UI test suite</name>
  <files>
    - tests/unit/test_rtl_layout.py
    - tests/integration/test_hebrew_ui.py
  </files>
  <action>
    1. Create tests/unit/test_rtl_layout.py:
       - test_translation_manager_is_rtl_for_hebrew()
       - test_translation_manager_not_rtl_for_english()
       - test_icon_mirroring_for_directional_icons()
       - test_icon_no_mirror_for_symmetric_icons()
       - test_qhboxlayout_reverses_in_rtl()
       - test_margins_swap_in_rtl()

    2. Create tests/integration/test_hebrew_ui.py:
       - test_main_window_rtl_layout(qtbot): Verify layoutDirection() is RightToLeft
       - test_all_panels_receive_rtl(qtbot): Check status, controls, history panels
       - test_hebrew_text_displayed(qtbot): Verify Hebrew strings appear
       - test_first_run_wizard_language_selection(qtbot): Complete language selection flow
       - test_language_switch_updates_ui(qtbot): Switch en->he and verify
       - test_directional_icons_mirrored(qtbot): Visual verification of icons
       - test_button_order_reversed_in_rtl(qtbot): Check button position in QHBoxLayout

    3. Mark tests with @pytest.mark.rtl for easy filtering

    4. Use qtbot fixtures for Qt widget testing
  </action>
  <verify>
    - Run: pytest tests/unit/test_rtl_layout.py tests/integration/test_hebrew_ui.py -v
    - All tests pass
  </verify>
  <done>
    - RTL unit tests cover TranslationManager and icon mirroring
    - Integration tests verify full Hebrew UI experience
    - Tests can be run with pytest -m rtl
  </done>
</task>

</tasks>

<verification>
Run full test suite with RTL tests:
```bash
pytest tests/unit/test_rtl_layout.py tests/integration/test_hebrew_ui.py -v --tb=short
```

Manual verification:
1. Launch app with Hebrew: `python -c "from src.resources.translations import get_translation_manager; get_translation_manager('he'); from src.main import main; main()"`
2. Verify all text is in Hebrew
3. Verify layout is RTL (controls on left, content flows right-to-left)
4. Verify directional icons (arrows) point correctly for RTL
</verification>

<success_criteria>
- I18N-03: All UI text displays in Hebrew when Hebrew language selected
- I18N-04: Hebrew mode uses RTL layout direction (verified programmatically and visually)
- I18N-05: Directional icons mirror correctly in RTL mode
- Test suite passes with 100% of RTL tests
</success_criteria>

<output>
After completion, create `.planning/phases/02-validation-i18n/02-01-SUMMARY.md`
</output>
